@startuml
' === CONFIGURACIÓN VISUAL ===
skinparam shadowing false
skinparam handwritten false
skinparam defaultFontName Helvetica
skinparam defaultFontSize 13

' Estilos
skinparam activity {
    BackgroundColor #0073B7
    BorderColor #005580
    FontColor White
    FontSize 12
    FontStyle bold
}

skinparam activityDiamond {
    BackgroundColor #F39C12
    BorderColor #D35400
    FontColor Black
    FontSize 12
    FontStyle bold
}

skinparam arrow {
    Color #555555
    Thickness 2
}

title "Flujo de Despliegue de Aplicación - NEBULA"

start

:Preparar docker-compose.yml;

' === BUCLE PRINCIPAL: DESPLIEGUE DEL CONTENEDOR ===
repeat :Intento de despliegue (máx. 3 veces);
  :Ejecutar 'docker compose up -d';
  
  if (¿Contenedor inició correctamente?) then (✓ Sí)
    :***CONTENEDOR ACTIVO***;
    break
  else (❌ No)
    :Revisar logs: docker compose logs;
    :Corregir errores en configuración;
    
    if (¿Error corregido?) then (✓ Sí)
      :Continuar al siguiente intento;
    else (❌ No)
      :Error crítico: abortar despliegue;
      stop
    endif
  endif
repeat while (¿Intentos < 3?) is (✓ Sí) not (❌ No)

' === FASE 2: CONFIGURACIÓN SSL ===
:Acceder a Nginx Proxy Manager (:81);
:Configurar Proxy Host;

repeat :Intento SSL (máx. 2 veces);
  :Solicitar certificado Let's Encrypt;
  
  if (¿SSL generado correctamente?) then (✓ Sí)
    :Verificar acceso HTTPS;
    :Revisar métricas en Netdata;
    :***DESPLIEGUE EXITOSO***;
    stop
  else (❌ No)
    :Diagnosticar error SSL;
    
    fork
      note right
        Posibles causas:
        1. Puertos 80/443 bloqueados
        2. DNS no resuelve
        3. Límite de rate limit de Let's Encrypt
      end note
    fork again
      :Revisar configuración UFW;
      :Verificar redirección de puertos;
    end fork
    
    :Reintentar en 5 minutos;
  endif
repeat while (¿Intentos SSL < 2?) is (✓ Sí) not (❌ No)

' === FALLO DEFINITIVO ===
:Registrar incidente en documentación;
:Notificar al administrador;
:***DESPLIEGUE FALLIDO - Requiere intervención manual***;

stop

@enduml
